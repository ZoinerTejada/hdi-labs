{"paragraphs":[{"text":"%md\n# Lab 6: Securing the Environment\n\nAdventureWorks has set up an [Azure Active Directory (AAD)](https://docs.microsoft.com/azure/active-directory/active-directory-whatis) domain, and has added user accounts and roles for employees to use when working with data. They want to make sure that sensitive information, such as user birthdates and passwords, is only accessible to admin-level employees. They have created a [domain-joined HDInsight Spark cluster](https://docs.microsoft.com/azure/hdinsight/hdinsight-domain-joined-configure) within a VNet, and joined to their AAD domain. Now they want to properly set up permissions to restrict access to certain data when users log in to Zeppelin to run queries, or generate reports from this data in Power BI.\n\nDomain-joined HDInsight clusters take advantage of strong authentication with Azure Active Directory users, as well as use role-based access control (RBAC) policies for various services, such as YARN and Hive. In this lab, you will view the users and groups synchronized from AAD in Ambari, use Ranger to control access to Hive tables, as well as configure data masks and row level filters. Finally, you will connect to your cluster's Hive tables in Power BI and observe the permissions being applied there.\n\n> To compare query results with different users, open this Zeppelin notebook in two different browsers, signing in as testuser1@contoso.com in one, and labuser@contoso.com in the other. This will allow you to see the difference in permissions applied to both accounts.","user":"testuser1","dateUpdated":"2017-10-29T22:45:08+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Lab 6: Securing the Environment</h1>\n<p>AdventureWorks has set up an <a href=\"https://docs.microsoft.com/azure/active-directory/active-directory-whatis\">Azure Active Directory (AAD)</a> domain, and has added user accounts and roles for employees to use when working with data. They want to make sure that sensitive information, such as user birthdates and passwords, is only accessible to admin-level employees. They have created a <a href=\"https://docs.microsoft.com/azure/hdinsight/hdinsight-domain-joined-configure\">domain-joined HDInsight Spark cluster</a> within a VNet, and joined to their AAD domain. Now they want to properly set up permissions to restrict access to certain data when users log in to Zeppelin to run queries, or generate reports from this data in Power BI.</p>\n<p>Domain-joined HDInsight clusters take advantage of strong authentication with Azure Active Directory users, as well as use role-based access control (RBAC) policies for various services, such as YARN and Hive. In this lab, you will view the users and groups synchronized from AAD in Ambari, use Ranger to control access to Hive tables, as well as configure data masks and row level filters. Finally, you will connect to your cluster&rsquo;s Hive tables in Power BI and observe the permissions being applied there.</p>\n<blockquote>\n  <p>To compare query results with different users, open this Zeppelin notebook in two different browsers, signing in as <a href=\"mailto:&#116;e&#115;&#x74;&#x75;&#x73;&#x65;&#114;&#x31;&#x40;c&#111;&#x6e;&#116;o&#115;&#111;&#46;c&#111;m\">&#116;e&#115;&#x74;&#x75;&#x73;&#x65;&#114;&#x31;&#x40;c&#111;&#x6e;&#116;o&#115;&#111;&#46;c&#111;m</a> in one, and <a href=\"mailto:&#x6c;&#97;&#x62;&#x75;&#115;&#101;r&#x40;&#x63;o&#110;&#x74;&#x6f;&#115;&#111;&#46;&#99;&#111;&#x6d;\">&#x6c;&#97;&#x62;&#x75;&#115;&#101;r&#x40;&#x63;o&#110;&#x74;&#x6f;&#115;&#111;&#46;&#99;&#111;&#x6d;</a> in the other. This will allow you to see the difference in permissions applied to both accounts.</p>\n</blockquote>\n</div>"}]},"apps":[],"jobName":"paragraph_1509300465345_2135927565","id":"20171029-180745_1334469836","dateCreated":"2017-10-29T18:07:45+0000","dateStarted":"2017-10-29T22:45:08+0000","dateFinished":"2017-10-29T22:45:08+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:22348"},{"text":"%md\nRun the show tables command using the %livy.sql magic below. This will show you Hive tables that are available for the currently logged in user. If you are logged in as testuser1, you should only see **hivesampletable** listed. If you are logged in as labuser, then you should see four tables listed in total. The reason testuser1 does not see weblogs, users, or products, is because the Hive permissions in Ranger has not been set up for the user or security group to which the user belongs.","user":"testuser1","dateUpdated":"2017-10-29T20:13:07+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Run the show tables command using the %livy.sql magic below. This will show you Hive tables that are available for the currently logged in user. If you are logged in as testuser1, you should only see <strong>hivesampletable</strong> listed. If you are logged in as labuser, then you should see four tables listed in total. The reason testuser1 does not see weblogs, users, or products, is because the Hive permissions in Ranger has not been set up for the user or security group to which the user belongs.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1509302102722_-1309181437","id":"20171029-183502_1656354820","dateCreated":"2017-10-29T18:35:02+0000","dateStarted":"2017-10-29T18:38:23+0000","dateFinished":"2017-10-29T18:38:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22349"},{"text":"%livy.sql\nshow tables","user":"testuser1","dateUpdated":"2017-10-29T21:10:08+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"database\ttableName\tisTemporary\ndefault\thivesampletable\tfalse"}]},"apps":[],"jobName":"paragraph_1509025906179_-32836456","id":"20171026-135146_1807221489","dateCreated":"2017-10-26T13:51:46+0000","dateStarted":"2017-10-29T21:10:09+0000","dateFinished":"2017-10-29T21:11:34+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22350"},{"text":"%md\n## Look at LDAP users and groups in Ambari\n\nSince we are using a domain-joined (or secure) cluster that is synchronized with AAD, we can look at the users and groups in Ambari. Open Ambari and look at users and groups under the Admin section. Be sure to log in with the labuser@contoso.com account, instead of the local cluster admin account.\n\nWhat you see should look similar to the following:\n\n![Ambari users](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ambari-users.png)\n\nNotice that some users have a Type of Local, while others have a Type of LDAP. The LDAP users are the ones that are synchronized from AAD, such as **labuser** and **testuser1**. When you look at the groups, the one that appears was also defined in AAD. Any changes you make to users and groups in AAD are automatically synchronized to Ambari and Ranger.","user":"testuser1","dateUpdated":"2017-10-29T20:08:36+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"text"},"editorMode":"ace/mode/text","editorHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>Look at LDAP users and groups in Ambari</h2>\n<p>Since we are using a domain-joined (or secure) cluster that is synchronized with AAD, we can look at the users and groups in Ambari. Open Ambari and look at users and groups under the Admin section. Be sure to log in with the <a href=\"mailto:&#108;&#97;b&#x75;&#115;e&#x72;&#x40;c&#111;&#110;&#116;o&#115;&#x6f;.&#x63;&#x6f;m\">&#108;&#97;b&#x75;&#115;e&#x72;&#x40;c&#111;&#110;&#116;o&#115;&#x6f;.&#x63;&#x6f;m</a> account, instead of the local cluster admin account.</p>\n<p>What you see should look similar to the following:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ambari-users.png\" alt=\"Ambari users\" /></p>\n<p>Notice that some users have a Type of Local, while others have a Type of LDAP. The LDAP users are the ones that are synchronized from AAD, such as <strong>labuser</strong> and <strong>testuser1</strong>. When you look at the groups, the one that appears was also defined in AAD. Any changes you make to users and groups in AAD are automatically synchronized to Ambari and Ranger.</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1509304240477_-174876571","id":"20171029-191040_2105374154","dateCreated":"2017-10-29T19:10:40+0000","dateStarted":"2017-10-29T20:08:32+0000","dateFinished":"2017-10-29T20:08:32+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22351"},{"text":"%md\n1. Open your HDInsight cluster blade on the [Azure Portal](https://portal.azure.com).\n2. On the top of the cluster Overview blade, select **Cluster Dashboard**.\n\n    ![Select the Cluster Dashboard link on the overview blade of your HDInsight cluster](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/cluster-dashboard-link.png)\n    \n3. Enter the credentials for **labuser@contoso.com**.\n4. Select the **labuser** dropdown in the upper-right corner, then select **Manage Ambari**.\n\n    ![Select Manage Ambari from the labuser dropdown](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/manage-ambari.png)\n\n5. Select **Users** under Users + Group Management on the left. This will show the list of users, as displayed above.\n\n    ![Select Users under Users + Group Management](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ambari-users-link.png)\n\n6. Now select **Groups** under Users + Group Management. You should see one group called **testgroup**. Select the group to see its group members.","user":"testuser1","dateUpdated":"2017-10-29T20:50:01+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<ol>\n  <li>Open your HDInsight cluster blade on the <a href=\"https://portal.azure.com\">Azure Portal</a>.</li>\n  <li>On the top of the cluster Overview blade, select <strong>Cluster Dashboard</strong>.\n    <p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/cluster-dashboard-link.png\" alt=\"Select the Cluster Dashboard link on the overview blade of your HDInsight cluster\" /></p>\n  </li>\n  <li>\n  <p>Enter the credentials for **<a href=\"mailto:&#108;&#97;&#98;&#117;&#x73;&#101;&#114;&#x40;&#x63;&#x6f;n&#x74;&#111;&#115;&#111;&#46;&#x63;&#111;m&#x2a;&#x2a;\">&#108;&#97;&#98;&#117;&#x73;&#101;&#114;&#x40;&#x63;&#x6f;n&#x74;&#111;&#115;&#111;&#46;&#x63;&#111;m&#x2a;&#x2a;</a>.</p></li>\n  <li>Select the <strong>labuser</strong> dropdown in the upper-right corner, then select <strong>Manage Ambari</strong>.\n    <p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/manage-ambari.png\" alt=\"Select Manage Ambari from the labuser dropdown\" /></p>\n  </li>\n  <li>\n    <p>Select <strong>Users</strong> under Users + Group Management on the left. This will show the list of users, as displayed above.</p>\n    <p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ambari-users-link.png\" alt=\"Select Users under Users + Group Management\" /></p>\n  </li>\n  <li>\n  <p>Now select <strong>Groups</strong> under Users + Group Management. You should see one group called <strong>testgroup</strong>. Select the group to see its group members.</p></li>\n</ol>\n</div>"}]},"apps":[],"jobName":"paragraph_1509304394578_1309682256","id":"20171029-191314_1996563830","dateCreated":"2017-10-29T19:13:14+0000","dateStarted":"2017-10-29T20:11:31+0000","dateFinished":"2017-10-29T20:11:31+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22352"},{"text":"%md\n## Configure Hive permissions in Ranger\n\nNow that you've verified that the domain group and users exist, you will need to open Ranger to configure access to the weblogs and users Hive tables for members of **testgroup**. The **labuser** domain user is an admin, and has access to all Hive tables. This is the user account that administrators and HR personnel use to view customer information and purchase history. Users assigned to testgroup (testuser1, testuser2, etc.) should have the following restrictions, per AdventureWorks' leadership:\n\n1. Have access to all columns in the weblogs table.\n2. Have access to **only** the following columns in the users table: id, email, firstname, lastname, username, title,\ngender, phone, age, cell, birthdate, registered\n3. The value of the birthdate column in the users table should be redacted.\n4. Can view all rows in the weblogs table, **except** those with a 'Purchased' action.\n\n> When you log in to Ranger, use your **labuser** credentials. Please note that this is just the user alias, not the email address you use to log in to all other services.","user":"testuser1","dateUpdated":"2017-10-29T20:52:33+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>Configure Hive permissions in Ranger</h2>\n<p>Now that you&rsquo;ve verified that the domain group and users exist, you will need to open Ranger to configure access to the weblogs and users Hive tables for members of <strong>testgroup</strong>. The <strong>labuser</strong> domain user is an admin, and has access to all Hive tables. This is the user account that administrators and HR personnel use to view customer information and purchase history. Users assigned to testgroup (testuser1, testuser2, etc.) should have the following restrictions, per AdventureWorks&rsquo; leadership:</p>\n<ol>\n  <li>Have access to all columns in the weblogs table.</li>\n  <li>Have access to <strong>only</strong> the following columns in the users table: id, email, firstname, lastname, username, title,<br/>gender, phone, age, cell, birthdate, registered</li>\n  <li>The value of the birthdate column in the users table should be redacted.</li>\n  <li>Can view all rows in the weblogs table, <strong>except</strong> those with a &lsquo;Purchased&rsquo; action.</li>\n</ol>\n<blockquote>\n  <p>When you log in to Ranger, use your <strong>labuser</strong> credentials. Please note that this is just the user alias, not the email address you use to log in to all other services.</p>\n</blockquote>\n</div>"}]},"apps":[],"jobName":"paragraph_1509305385794_-1581900009","id":"20171029-192945_912117013","dateCreated":"2017-10-29T19:29:45+0000","dateStarted":"2017-10-29T20:52:33+0000","dateFinished":"2017-10-29T20:52:33+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22353"},{"text":"%md\n### Create Hive access policies in Ranger\n\nCreate two new access policies in Ranger. One access policy, named `read-weblogs-all`, should allow users in the `testgroup` group to have `select` permissions for all columns (*) in the `weblogs` table in the `default` database. The other access policy, named `read-users-restricted`, should allow users in the `testgroup` group to have `select` permissions in the `weblogs` table in the `default` database on only the following columns: id, email, firstname, lastname, username, title, gender, phone, age, cell, birthdate, registered.\n\nWhen you are done, your Hive access policies should look similar to the following:\n\n![Ranger access policies](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ranger-access-policies.png)","user":"testuser1","dateUpdated":"2017-10-29T21:31:32+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h3>Create Hive access policies in Ranger</h3>\n<p>Create two new access policies in Ranger. One access policy, named <code>read-weblogs-all</code>, should allow users in the <code>testgroup</code> group to have <code>select</code> permissions for all columns (*) in the <code>weblogs</code> table in the <code>default</code> database. The other access policy, named <code>read-users-restricted</code>, should allow users in the <code>testgroup</code> group to have <code>select</code> permissions in the <code>weblogs</code> table in the <code>default</code> database on only the following columns: id, email, firstname, lastname, username, title, gender, phone, age, cell, birthdate, registered.</p>\n<p>When you are done, your Hive access policies should look similar to the following:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ranger-access-policies.png\" alt=\"Ranger access policies\" /></p>\n</div>"}]},"apps":[],"jobName":"paragraph_1509309625560_1214707809","id":"20171029-204025_1202359906","dateCreated":"2017-10-29T20:40:25+0000","dateStarted":"2017-10-29T21:31:32+0000","dateFinished":"2017-10-29T21:31:32+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22354"},{"text":"%md\n1. Open Ranger by browsing to https://YOUR-CLUSTER-NAME.azurehdinsight.net/ranger (substitute YOUR-CLUSTER-NAME with the name of your cluster)\n2. When prompted, log in with **labuser** as the username, and the password.\n3. On the Ranger dashboard, select your cluster underneath the Hive title in the Service Manager.\n\n    ![Select your cluster undernath the Hive tile](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ranger-hive-link.png)\n\n4. Make sure the **Access** tab is selected.\n5. Click **Add New Policy**\n5. Provide \"read-weblogs-all\" for the Policy name.\n6. Type \"default\" and select from the resulting list for Database.\n7. Enter and select \"weblogs\" for the Table.\n8. Enter and select \"*\" for the Hive Column.\n9. Optionally provide a Description.\n10. Enter and select \"testgroup\" under Select Group.\n11. Click the edit button under Permissions and select the **select** permission.\n12. Click Add.\n\nYour form should look as follows:\n\n![Create weblogs policy](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-weblogs-policy.png)\n\nNow add a policy for the users table:\n\n1. Click **Add New Policy**\n2. Provide \"read-users-restricted\" for the Policy name.\n3. Type \"default\" and select from the resulting list for Database.\n4. Enter and select \"users\" for the Table.\n5. Enter and select each of the following for the Hive Column: id, email, firstname, lastname, username, title, gender, phone, age, cell, birthdate, registered.\n6. Optionally provide a Description.\n7. Enter and select \"testgroup\" under Select Group.\n8. Click the edit button under Permissions and select the **select** permission.\n9. Click Add.\n\nYour form should look as follows:\n\n![Create users policy](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-users-policy.png)","user":"testuser1","dateUpdated":"2017-10-29T21:40:59+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509310384890_1233435146","id":"20171029-205304_449518567","dateCreated":"2017-10-29T20:53:04+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22355","dateFinished":"2017-10-29T21:40:59+0000","dateStarted":"2017-10-29T21:40:59+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<ol>\n  <li>Open Ranger by browsing to <a href=\"https://YOUR-CLUSTER-NAME.azurehdinsight.net/ranger\">https://YOUR-CLUSTER-NAME.azurehdinsight.net/ranger</a> (substitute YOUR-CLUSTER-NAME with the name of your cluster)</li>\n  <li>When prompted, log in with <strong>labuser</strong> as the username, and the password.</li>\n  <li>On the Ranger dashboard, select your cluster underneath the Hive title in the Service Manager.\n    <p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ranger-hive-link.png\" alt=\"Select your cluster undernath the Hive tile\" /></p>\n  </li>\n  <li>\n  <p>Make sure the <strong>Access</strong> tab is selected.</p></li>\n  <li>Click <strong>Add New Policy</strong></li>\n  <li>Provide &ldquo;read-weblogs-all&rdquo; for the Policy name.</li>\n  <li>Type &ldquo;default&rdquo; and select from the resulting list for Database.</li>\n  <li>Enter and select &ldquo;weblogs&rdquo; for the Table.</li>\n  <li>Enter and select &quot;*&quot; for the Hive Column.</li>\n  <li>Optionally provide a Description.</li>\n  <li>Enter and select &ldquo;testgroup&rdquo; under Select Group.</li>\n  <li>Click the edit button under Permissions and select the <strong>select</strong> permission.</li>\n  <li>Click Add.</li>\n</ol>\n<p>Your form should look as follows:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-weblogs-policy.png\" alt=\"Create weblogs policy\" /></p>\n<p>Now add a policy for the users table:</p>\n<ol>\n  <li>Click <strong>Add New Policy</strong></li>\n  <li>Provide &ldquo;read-users-restricted&rdquo; for the Policy name.</li>\n  <li>Type &ldquo;default&rdquo; and select from the resulting list for Database.</li>\n  <li>Enter and select &ldquo;users&rdquo; for the Table.</li>\n  <li>Enter and select each of the following for the Hive Column: id, email, firstname, lastname, username, title, gender, phone, age, cell, birthdate, registered.</li>\n  <li>Optionally provide a Description.</li>\n  <li>Enter and select &ldquo;testgroup&rdquo; under Select Group.</li>\n  <li>Click the edit button under Permissions and select the <strong>select</strong> permission.</li>\n  <li>Click Add.</li>\n</ol>\n<p>Your form should look as follows:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-users-policy.png\" alt=\"Create users policy\" /></p>\n</div>"}]}},{"text":"%md\nNow that you've added access policies for both weblogs and users, execute the show tables command once more to see if these tables now appear in the results.","user":"testuser1","dateUpdated":"2017-10-29T21:13:10+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509311542512_1294109457","id":"20171029-211222_21533253","dateCreated":"2017-10-29T21:12:22+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:23723","dateFinished":"2017-10-29T21:13:13+0000","dateStarted":"2017-10-29T21:13:10+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Now that you&rsquo;ve added access policies for both weblogs and users, execute the show tables command once more to see if these tables now appear in the results.</p>\n</div>"}]}},{"text":"%livy.sql\nshow tables","user":"testuser1","dateUpdated":"2017-10-29T21:13:55+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509311596930_-667832454","id":"20171029-211316_1547390549","dateCreated":"2017-10-29T21:13:16+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:23801","dateFinished":"2017-10-29T21:14:01+0000","dateStarted":"2017-10-29T21:13:55+0000","results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"database\ttableName\tisTemporary\ndefault\tweblogs\tfalse\ndefault\tusers\tfalse\ndefault\thivesampletable\tfalse"}]}},{"text":"%md\nNotice that weblogs and users appear in the list of tables. Now let's see if we can select the first 10 rows from the weblogs table.","user":"testuser1","dateUpdated":"2017-10-29T21:15:52+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"text"},"editorMode":"ace/mode/text","editorHide":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509311650500_-2111197433","id":"20171029-211410_1485979446","dateCreated":"2017-10-29T21:14:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:23947","dateFinished":"2017-10-29T21:15:47+0000","dateStarted":"2017-10-29T21:15:47+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Notice that weblogs and users appear in the list of tables. Now let&rsquo;s see if we can select the first 10 rows from the weblogs table.</p>\n</div>"}]}},{"text":"%livy.sql\nselect * from weblogs limit 10","user":"testuser1","dateUpdated":"2017-10-29T21:20:55+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"userid\tsessionid\tproductid\tquantity\tprice\ttotalprice\treferralurl\tpagestopduration\taction\ttransactiondate\tcleanedtransactiondate\n9245\td8146381-63be-44a...\t525\t0\t20.0\t0.0\txyz.com\t141\tBrowsed\t5/5/2016 12:20:00 AM\t2016-05-05 00:20:...\n9245\td8146381-63be-44a...\t527\t0\t30.0\t0.0\thttp://contoso.co...\t168\tBrowsed\t5/5/2016 12:22:21 AM\t2016-05-05 00:22:...\n9245\td8146381-63be-44a...\t519\t0\t20.0\t0.0\thttp://contoso.co...\t63\tBrowsed\t5/5/2016 12:25:09 AM\t2016-05-05 00:25:...\n9245\td8146381-63be-44a...\t516\t0\t50.0\t0.0\thttp://contoso.co...\t15\tBrowsed\t5/5/2016 12:26:12 AM\t2016-05-05 00:26:...\n9245\td8146381-63be-44a...\t525\t0\t20.0\t0.0\thttp://contoso.co...\t145\tBrowsed\t5/5/2016 12:26:27 AM\t2016-05-05 00:26:...\n9245\td8146381-63be-44a...\t517\t0\t24.0\t0.0\thttp://contoso.co...\t30\tBrowsed\t5/5/2016 12:28:52 AM\t2016-05-05 00:28:...\n9245\td8146381-63be-44a...\t527\t0\t30.0\t0.0\thttp://contoso.co...\t167\tBrowsed\t5/5/2016 12:29:22 AM\t2016-05-05 00:29:...\n9245\td8146381-63be-44a...\t526\t0\t40.0\t0.0\thttp://contoso.co...\t165\tBrowsed\t5/5/2016 12:32:09 AM\t2016-05-05 00:32:...\n9245\td8146381-63be-44a...\t517\t0\t24.0\t0.0\thttp://contoso.co...\t25\tBrowsed\t5/5/2016 12:34:54 AM\t2016-05-05 00:34:...\n9245\td8146381-63be-44a...\t522\t0\t90.0\t0.0\thttp://contoso.co...\t107\tBrowsed\t5/5/2016 12:35:19 AM\t2016-05-05 00:35:..."}]},"apps":[],"jobName":"paragraph_1509025926070_1389393048","id":"20171026-135206_1324822431","dateCreated":"2017-10-26T13:52:06+0000","dateStarted":"2017-10-29T21:20:55+0000","dateFinished":"2017-10-29T21:21:05+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22356"},{"text":"%md\nYou should see the first 10 rows, as expected. Now, lets try to select * from users, returning the first 10 and see what happens.","user":"testuser1","dateUpdated":"2017-10-29T21:17:15+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509311775674_-1173732929","id":"20171029-211615_1015069836","dateCreated":"2017-10-29T21:16:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:24025","dateFinished":"2017-10-29T21:17:15+0000","dateStarted":"2017-10-29T21:17:15+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>You should see the first 10 rows, as expected. Now, lets try to select * from users, returning the first 10 and see what happens.</p>\n</div>"}]}},{"text":"%livy.sql\nselect * from users limit 10","user":"testuser1","dateUpdated":"2017-10-29T21:17:40+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509311842672_-815238900","id":"20171029-211722_2127522771","dateCreated":"2017-10-29T21:17:22+0000","status":"ERROR","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:24150","dateFinished":"2017-10-29T21:17:47+0000","dateStarted":"2017-10-29T21:17:40+0000","results":{"code":"ERROR","msg":[{"type":"TEXT","data":"java.io.IOException: shadehive.org.apache.hive.service.cli.HiveSQLException: java.io.IOException: org.apache.hadoop.hive.ql.metadata.HiveException: Failed to compile query: org.apache.hadoop.hive.ql.security.authorization.plugin.HiveAccessControlException: Permission denied: user [testuser1] does not have [SELECT] privilege on [default/users/*]"}]}},{"text":"%md\nWell, that didn't work. Notice the permission error telling you that testuser1 does not have select privilege on *. Remember, for members of the testgroup, only select privileges on specific columns were granted.\n\nNow retry the query, this time specifying the following columns: id, email, firstname, lastname, username, title, gender, phone, age, cell, birthdate, registered.","user":"testuser1","dateUpdated":"2017-10-29T21:20:06+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509311846147_-587082802","id":"20171029-211726_1190826685","dateCreated":"2017-10-29T21:17:26+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:24209","dateFinished":"2017-10-29T21:20:06+0000","dateStarted":"2017-10-29T21:20:06+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Well, that didn&rsquo;t work. Notice the permission error telling you that testuser1 does not have select privilege on *. Remember, for members of the testgroup, only select privileges on specific columns were granted.</p>\n<p>Now retry the query, this time specifying the following columns: id, email, firstname, lastname, username, title, gender, phone, age, cell, birthdate, registered.</p>\n</div>"}]}},{"text":"%livy.sql\nselect id, email, firstname, lastname, username, title,\ngender, phone, age, cell, birthdate, registered\nfrom users limit 10","user":"testuser1","dateUpdated":"2017-10-29T21:20:16+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"id\temail\tfirstname\tlastname\tusername\ttitle\tgender\tphone\tage\tcell\tbirthdate\tregistered\n9858\tNaN\ttiago\tekelmans\tblueswan862\tmr\tMale\t(107)-025-5278\t53\t(670)-009-2361\t1964-11-24 10:54:...\t2016-10-11 07:38:...\n9859\tNaN\trasmus\tramo\tsmallmouse340\tmr\tMale\t09-668-830\t59\t046-374-16-05\t1958-01-18 21:26:...\t2007-06-08 11:03:...\n9860\tNaN\tbelen\tmoya\theavygoose883\tms\tFemale\t968-061-272\t20\t608-109-987\t1997-06-21 13:22:...\t2004-08-17 17:58:...\n9861\tNaN\tgregorio\tcruz\tsmallswan342\tmr\tMale\t955-047-150\t44\t623-541-744\t1973-10-06 17:18:...\t2008-05-03 20:38:...\n9862\tNaN\tperry\twade\tsmallladybug419\tmr\tMale\t051-061-1555\t64\t081-420-7174\t1953-08-19 12:32:...\t2003-09-29 01:26:...\n9863\tNaN\tbegÃ¼\t| Ã§Ã¶re\tÃ§i|ticklishbir\t242|\tiss|Fe\tale|(029)-522-\t263\t20|(100)-371-\t523|1997-10-23 23:43\t...|2005-04-08 23:21\n9864\tNaN\tjoy\tdixon\ttinywolf757\tmiss\tFemale\t06-8859-5359\t58\t0452-907-558\t1959-09-04 07:33:...\t2007-09-16 11:25:...\n9865\tNaN\tfelix\tking\tbigduck347\tmr\tMale\t(229)-272-5333\t33\t(389)-445-2434\t1984-07-18 10:22:...\t2005-04-14 23:02:...\n9866\tNaN\tseth\tchambers\tredduck456\tmr\tMale\t00-2010-4256\t49\t0459-686-815\t1968-12-18 17:26:...\t2009-10-12 00:06:...\n9867\tNaN\tmatÃ©\t| meunie\t|  whitepanda37\t|monsieu\t|  Mal\t|(701)-449-727\t| 3\t|(480)-841-526\t|1986-11-25 11:57:..\t|2008-04-29 21:18:.."}]},"apps":[],"jobName":"paragraph_1509025937889_-19942173","id":"20171026-135217_726842501","dateCreated":"2017-10-26T13:52:17+0000","dateStarted":"2017-10-29T21:20:16+0000","dateFinished":"2017-10-29T21:20:30+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22357"},{"text":"%md\n### Create dynamic column masking policy\n\nAlthough members of testgroup have permissions to see birthdates in the users table, AdventureWorks' admins have asked to mask the values in this column, at least for now. That way, members of this group can include this column in queries and reports in the meantime, without being able to see the actual data. To accomplish this, create a new dynamic column masking policy in Ranger, named `mask-users-birthdate`. This should apply a mask condition on users in the `testgroup` group to have the `Redact` select masking option on `select` operations for the `birthdate` column in the `weblogs` table in the `default` database.\n\nWhen you are done, your Hive masking policies should look similar to the following:\n\n![Ranger access policies](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ranger-masking-policies.png)","user":"testuser1","dateUpdated":"2017-10-29T21:50:08+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509312603064_-467271899","id":"20171029-213003_491251126","dateCreated":"2017-10-29T21:30:03+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:24573","dateFinished":"2017-10-29T21:50:08+0000","dateStarted":"2017-10-29T21:50:08+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h3>Create dynamic column masking policy</h3>\n<p>Although members of testgroup have permissions to see birthdates in the users table, AdventureWorks&rsquo; admins have asked to mask the values in this column, at least for now. That way, members of this group can include this column in queries and reports in the meantime, without being able to see the actual data. To accomplish this, create a new dynamic column masking policy in Ranger, named <code>mask-users-birthdate</code>. This should apply a mask condition on users in the <code>testgroup</code> group to have the <code>Redact</code> select masking option on <code>select</code> operations for the <code>birthdate</code> column in the <code>weblogs</code> table in the <code>default</code> database.</p>\n<p>When you are done, your Hive masking policies should look similar to the following:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ranger-masking-policies.png\" alt=\"Ranger access policies\" /></p>\n</div>"}]}},{"text":"%md\n1. Switch back over to Ranger and make sure you are back in the Hive Policies section.\n2. Select the **Masking** tab.\n3. Click **Add New Policy**\n4. Provide \"mask-users-birthdate\" for the Policy name.\n5. Type \"default\" and select from the resulting list for Database.\n6. Enter and select \"weblogs\" for the Table.\n7. Enter and select \"birthdate\" for the Hive Column.\n8. Optionally provide a Description.\n9. Enter and select \"testgroup\" under Select Group.\n10. Click the edit button under Access Types and select the **select** and **Select/Deselect All** access types.\n11. Click the edit button under Select Masking Option and select **Redact**.\n12. Click Add.\n\nYour form should look as follows:\n\n![Create mask users birthdate dynamic masking policy](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-mask.png)","user":"testuser1","dateUpdated":"2017-10-29T22:40:30+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509313281410_-1697384176","id":"20171029-214121_1517220665","dateCreated":"2017-10-29T21:41:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:24739","dateFinished":"2017-10-29T22:40:30+0000","dateStarted":"2017-10-29T22:40:30+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<ol>\n  <li>Switch back over to Ranger and make sure you are back in the Hive Policies section.</li>\n  <li>Select the <strong>Masking</strong> tab.</li>\n  <li>Click <strong>Add New Policy</strong></li>\n  <li>Provide &ldquo;mask-users-birthdate&rdquo; for the Policy name.</li>\n  <li>Type &ldquo;default&rdquo; and select from the resulting list for Database.</li>\n  <li>Enter and select &ldquo;weblogs&rdquo; for the Table.</li>\n  <li>Enter and select &ldquo;birthdate&rdquo; for the Hive Column.</li>\n  <li>Optionally provide a Description.</li>\n  <li>Enter and select &ldquo;testgroup&rdquo; under Select Group.</li>\n  <li>Click the edit button under Access Types and select the <strong>select</strong> and <strong>Select/Deselect All</strong> access types.</li>\n  <li>Click the edit button under Select Masking Option and select <strong>Redact</strong>.</li>\n  <li>Click Add.</li>\n</ol>\n<p>Your form should look as follows:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-mask.png\" alt=\"Create mask users birthdate dynamic masking policy\" /></p>\n</div>"}]}},{"text":"%md\nNow let's see whether the masking policy is properly redacting the birthdate column in the users table for our testuser1 account.","user":"testuser1","dateUpdated":"2017-10-29T22:44:23+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509313549600_-294775221","id":"20171029-214549_215320024","dateCreated":"2017-10-29T21:45:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:24808","dateFinished":"2017-10-29T22:44:23+0000","dateStarted":"2017-10-29T22:44:23+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Now let&rsquo;s see whether the masking policy is properly redacting the birthdate column in the users table for our testuser1 account.</p>\n</div>"}]}},{"text":"%livy.sql\nselect id, email, firstname, lastname, username, title,\ngender, phone, age, cell, birthdate, registered\nfrom users limit 10","user":"testuser1","dateUpdated":"2017-10-29T21:48:34+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509313552826_-280524187","id":"20171029-214552_999028446","dateCreated":"2017-10-29T21:45:52+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:24864","dateFinished":"2017-10-29T21:48:43+0000","dateStarted":"2017-10-29T21:48:34+0000","results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"id\temail\tfirstname\tlastname\tusername\ttitle\tgender\tphone\tage\tcell\tbirthdate\tregistered\n9858\tNaN\ttiago\tekelmans\tblueswan862\tmr\tMale\t(107)-025-5278\t53\t(670)-009-2361\tnull\t2016-10-11 07:38:...\n9859\tNaN\trasmus\tramo\tsmallmouse340\tmr\tMale\t09-668-830\t59\t046-374-16-05\tnull\t2007-06-08 11:03:...\n9860\tNaN\tbelen\tmoya\theavygoose883\tms\tFemale\t968-061-272\t20\t608-109-987\tnull\t2004-08-17 17:58:...\n9861\tNaN\tgregorio\tcruz\tsmallswan342\tmr\tMale\t955-047-150\t44\t623-541-744\tnull\t2008-05-03 20:38:...\n9862\tNaN\tperry\twade\tsmallladybug419\tmr\tMale\t051-061-1555\t64\t081-420-7174\tnull\t2003-09-29 01:26:...\n9863\tNaN\tbegÃ¼\t| Ã§Ã¶re\tÃ§i|ticklishbir\t242|\tiss|Fe\tale|(029)-522-\t263\t20|(100)-371-\t523|\tull|2005-04-08 23:21\n9864\tNaN\tjoy\tdixon\ttinywolf757\tmiss\tFemale\t06-8859-5359\t58\t0452-907-558\tnull\t2007-09-16 11:25:...\n9865\tNaN\tfelix\tking\tbigduck347\tmr\tMale\t(229)-272-5333\t33\t(389)-445-2434\tnull\t2005-04-14 23:02:...\n9866\tNaN\tseth\tchambers\tredduck456\tmr\tMale\t00-2010-4256\t49\t0459-686-815\tnull\t2009-10-12 00:06:...\n9867\tNaN\tmatÃ©\t| meunie\t|  whitepanda37\t|monsieu\t|  Mal\t|(701)-449-727\t| 3\t|(480)-841-526\t|     nul\t|2008-04-29 21:18:.."}]}},{"text":"%md\nNotice that the date values in the birthdate column are all listed as null. Great! Now we need to apply a row level filter.\n\nSelect the first 10 rows from weblogs where the action value is 'Purchased'. When you run this while logged in with the testuser1 account, you should see results.","user":"testuser1","dateUpdated":"2017-10-29T22:43:49+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509313556063_-245512037","id":"20171029-214556_734734909","dateCreated":"2017-10-29T21:45:56+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:24925","dateFinished":"2017-10-29T22:43:49+0000","dateStarted":"2017-10-29T22:43:49+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Notice that the date values in the birthdate column are all listed as null. Great! Now we need to apply a row level filter.</p>\n<p>Select the first 10 rows from weblogs where the action value is &lsquo;Purchased&rsquo;. When you run this while logged in with the testuser1 account, you should see results.</p>\n</div>"}]}},{"text":"%livy.sql\nselect * from weblogs\nwhere action = 'Purchased'\nlimit 10","user":"testuser1","dateUpdated":"2017-10-29T22:32:37+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"userid\tsessionid\tproductid\tquantity\tprice\ttotalprice\treferralurl\tpagestopduration\taction\ttransactiondate\tcleanedtransactiondate\n2748\tb5fc08c5-df9c-474...\t583\t4\t46.0\t184.0\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:14:06 AM\t2016-05-05 01:14:...\n8768\t847d6f45-7957-42f...\t517\t1\t24.0\t24.0\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:09:56 AM\t2016-05-05 01:09:...\n3544\t3edd8c19-5f34-4d1...\t237\t1\t70.54\t70.54\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:33:56 AM\t2016-05-05 01:33:...\n3702\teee73e38-4cee-46a...\t237\t1\t70.54\t70.54\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:33:56 AM\t2016-05-05 01:33:...\n1317\t26ca4067-af43-42b...\t584\t1\t20.0\t20.0\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:33:56 AM\t2016-05-05 01:33:...\n4128\t0bce029a-b056-419...\t237\t1\t70.54\t70.54\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:33:56 AM\t2016-05-05 01:33:...\n1143\t9296291e-556d-48b...\t584\t1\t20.0\t20.0\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:33:56 AM\t2016-05-05 01:33:...\n7229\te956745b-418e-421...\t291\t1\t30.0\t30.0\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:33:56 AM\t2016-05-05 01:33:...\n5378\t5600b8ed-c5fb-4d2...\t399\t1\t65.0\t65.0\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:33:56 AM\t2016-05-05 01:33:...\n4025\tf52361b1-f285-491...\t237\t1\t70.54\t70.54\thttp://contoso.co...\t0\tPurchased\t5/5/2016 1:33:56 AM\t2016-05-05 01:33:..."}]},"apps":[],"jobName":"paragraph_1509026016180_-31930685","id":"20171026-135336_302299852","dateCreated":"2017-10-26T13:53:36+0000","dateStarted":"2017-10-29T22:32:37+0000","dateFinished":"2017-10-29T22:32:48+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22358","focus":true},{"text":"%md\n### Create row level filter policy\n\nAlthough members of the `testgroup` have access to the weblogs table, they should not be able to see transactions for purchase actions. Only admin-level users should view those records. To accomplish this, create a new row level filter policy in Ranger, named `hide-weblogs-purchased`. This should apply a row filter condition on users in the `testgroup` group to have the `action <> 'Purchased'` row level filter applied on `select` operations in the `weblogs` table in the `default` database.\n\nWhen you are done, your Hive row level filter policies should look similar to the following:\n\n![Ranger row level fitler policies](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ranger-rls-policies.png)","user":"testuser1","dateUpdated":"2017-10-29T23:05:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"scala"},"editorMode":"ace/mode/scala","editorHide":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509313819050_-786116535","id":"20171029-215019_1862258363","dateCreated":"2017-10-29T21:50:19+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:25230","dateFinished":"2017-10-29T23:05:48+0000","dateStarted":"2017-10-29T23:05:48+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h3>Create row level filter policy</h3>\n<p>Although members of the <code>testgroup</code> have access to the weblogs table, they should not be able to see transactions for purchase actions. Only admin-level users should view those records. To accomplish this, create a new row level filter policy in Ranger, named <code>hide-weblogs-purchased</code>. This should apply a row filter condition on users in the <code>testgroup</code> group to have the <code>action &lt;&gt; &#39;Purchased&#39;</code> row level filter applied on <code>select</code> operations in the <code>weblogs</code> table in the <code>default</code> database.</p>\n<p>When you are done, your Hive row level filter policies should look similar to the following:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/ranger-rls-policies.png\" alt=\"Ranger row level fitler policies\" /></p>\n</div>"}]}},{"text":"%md\n1. Switch back over to Ranger and make sure you are back in the Hive Policies section.\n2. Select the **Row Level Filter** tab.\n3. Click **Add New Policy**\n4. Provide \"hide-weblogs-purchased\" for the Policy name.\n5. Type \"default\" and select from the resulting list for Database.\n6. Enter and select \"weblogs\" for the Table.\n8. Optionally provide a Description.\n9. Enter and select \"testgroup\" under Select Group.\n10. Click the edit button under Access Types and select the **select** and **Select/Deselect All** access types.\n11. Click the edit button under Row Level Filter and select enter the following filter expression: `action <> 'Purchased'`.\n12. Click Add.\n\nYour form should look as follows:\n\n![Create row level filter policy](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-rls.png)","user":"testuser1","dateUpdated":"2017-10-29T22:43:31+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509313822095_-381745441","id":"20171029-215022_2031137581","dateCreated":"2017-10-29T21:50:22+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:25286","dateFinished":"2017-10-29T22:43:31+0000","dateStarted":"2017-10-29T22:43:31+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<ol>\n  <li>Switch back over to Ranger and make sure you are back in the Hive Policies section.</li>\n  <li>Select the <strong>Row Level Filter</strong> tab.</li>\n  <li>Click <strong>Add New Policy</strong></li>\n  <li>Provide &ldquo;hide-weblogs-purchased&rdquo; for the Policy name.</li>\n  <li>Type &ldquo;default&rdquo; and select from the resulting list for Database.</li>\n  <li>Enter and select &ldquo;weblogs&rdquo; for the Table.</li>\n  <li>Optionally provide a Description.</li>\n  <li>Enter and select &ldquo;testgroup&rdquo; under Select Group.</li>\n  <li>Click the edit button under Access Types and select the <strong>select</strong> and <strong>Select/Deselect All</strong> access types.</li>\n  <li>Click the edit button under Row Level Filter and select enter the following filter expression: <code>action &lt;&gt; &#39;Purchased&#39;</code>.</li>\n  <li>Click Add.</li>\n</ol>\n<p>Your form should look as follows:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-rls.png\" alt=\"Create row level filter policy\" /></p>\n</div>"}]}},{"text":"%md\nWith the new row level filter policy created, try selecting records from weblogs where action = 'Purchased' once again. This time, no records should return if you're logged in as testuser1.","user":"testuser1","dateUpdated":"2017-10-29T22:46:28+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509317136608_846142588","id":"20171029-224536_837255634","dateCreated":"2017-10-29T22:45:36+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:25598","dateFinished":"2017-10-29T22:46:28+0000","dateStarted":"2017-10-29T22:46:28+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>With the new row level filter policy created, try selecting records from weblogs where action = &lsquo;Purchased&rsquo; once again. This time, no records should return if you&rsquo;re logged in as testuser1.</p>\n</div>"}]}},{"text":"%livy.sql\nselect * from weblogs\nwhere action = 'Purchased'\nlimit 10","user":"testuser1","dateUpdated":"2017-10-29T22:46:33+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"userid\tsessionid\tproductid\tquantity\tprice\ttotalprice\treferralurl\tpagestopduration\taction\ttransactiondate\tcleanedtransactiondate"}]},"apps":[],"jobName":"paragraph_1509031604831_1627582963","id":"20171026-152644_747617502","dateCreated":"2017-10-26T15:26:44+0000","dateStarted":"2017-10-29T22:46:33+0000","dateFinished":"2017-10-29T22:46:44+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22359"},{"text":"%md\nLet's execute one more query that gives us a count of each action in weblogs. We'll use this same data to create a chart in Power BI. You should see that the query results show the counts for Add To Cart and Browsed, but not Purchased, due to the row level filter.","user":"testuser1","dateUpdated":"2017-10-29T22:48:15+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509317215160_-611768396","id":"20171029-224655_1978320029","dateCreated":"2017-10-29T22:46:55+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:25754","dateFinished":"2017-10-29T22:48:15+0000","dateStarted":"2017-10-29T22:48:15+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Let&rsquo;s execute one more query that gives us a count of each action in weblogs. We&rsquo;ll use this same data to create a chart in Power BI. You should see that the query results show the counts for Add To Cart and Browsed, but not Purchased, due to the row level filter.</p>\n</div>"}]}},{"text":"%livy.sql\nselect action, COUNT(*) as Transactions from weblogs\ngroup by action","user":"testuser1","dateUpdated":"2017-10-29T22:48:19+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"sql"},"editorMode":"ace/mode/sql","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"action\tTransactions\nAdd To Cart\t2494871\nBrowsed\t81123141"}]},"apps":[],"jobName":"paragraph_1509026141370_-1793125615","id":"20171026-135541_2032864170","dateCreated":"2017-10-26T13:55:41+0000","dateStarted":"2017-10-29T22:48:19+0000","dateFinished":"2017-10-29T22:50:12+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22360"},{"text":"%md\n## Create report in Power BI using domain user credentials\n\nPower BI gives us the ability to create nice visualizations from data stored in a multitude of sources, include HDInsight. AdventureWorks would like to create a clustered bar chart that shows a count of user actions against the weblogs data at any time. What they expect is that when a member of testgroup uses their domain credentials to create the report, they will only see results for non-purchase actions, as seen in the above query.\n\nDownload and run the [Power BI Desktop](https://powerbi.microsoft.com/desktop/) software to create a DirectQuery connection to your domain-joined cluster, using the login credentials for the **testuser1@contoso.com** domain user. Create a clustered column chart that shows the counts for the following actions: Add To Cart and Browsed.\n\nThe end result should look like the following:\n\n![Power BI clustered column chart](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/chart.png)","user":"testuser1","dateUpdated":"2017-10-29T23:06:25+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509064538357_-869078135","id":"20171027-003538_832278149","dateCreated":"2017-10-27T00:35:38+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:22361","dateFinished":"2017-10-29T23:06:25+0000","dateStarted":"2017-10-29T23:06:25+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>Create report in Power BI using domain user credentials</h2>\n<p>Power BI gives us the ability to create nice visualizations from data stored in a multitude of sources, include HDInsight. AdventureWorks would like to create a clustered bar chart that shows a count of user actions against the weblogs data at any time. What they expect is that when a member of testgroup uses their domain credentials to create the report, they will only see results for non-purchase actions, as seen in the above query.</p>\n<p>Download and run the <a href=\"https://powerbi.microsoft.com/desktop/\">Power BI Desktop</a> software to create a DirectQuery connection to your domain-joined cluster, using the login credentials for the **<a href=\"mailto:&#x74;&#101;&#115;&#116;&#117;&#x73;&#101;&#114;&#49;&#x40;&#99;&#111;&#x6e;&#116;&#x6f;&#x73;&#x6f;&#x2e;&#99;&#x6f;&#109;&#42;*\">&#x74;&#101;&#115;&#116;&#117;&#x73;&#101;&#114;&#49;&#x40;&#99;&#111;&#x6e;&#116;&#x6f;&#x73;&#x6f;&#x2e;&#99;&#x6f;&#109;&#42;*</a> domain user. Create a clustered column chart that shows the counts for the following actions: Add To Cart and Browsed.</p>\n<p>The end result should look like the following:</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/chart.png\" alt=\"Power BI clustered column chart\" /></p>\n</div>"}]}},{"text":"%md\n1. From Power BI Desktop, select dropdown under **Get Data**, then **More...**. In the Get Data window, select Azure, then Azure HDInsight Spark (Beta).\n\n    ![Power BI Get Data](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/get-data.png)\n\n2. Enter your Spark cluster's server name in the Server field. This will be [YOUR_CLUSTER_NAME].azurehdinsight.net.\n3. Select DirectQuery as the data connectivity mode, then click OK.\n\n    ![Power BI DirectQuery](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/get-data-directquery.png)\n\n4. Enter the domain credentials for `testuser1@contoso.com`.\n5. After authenticating, continue to the next step and check the box next to the weblogs table, then click Load.\n\n    ![Select the weblogs table](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/power-bi-get-data.png)\n\n\nNow that the weblogs table is loaded and shown, along with its columns, on the right-hand side of the new report, follow these steps to create the chart:\n\n1. Select the Clustered Column Chart visualization.\n2. Drag the Action column within the weblogs table to the Axis field.\n3. Drag the Action column to the Value field. This should display the Count of Action.\n\n    ![Create the clustered column chart](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-chart.png)\n\n\nYou will see that the Add To Cart and Browsed actions are included, but not the Purchased action. This is because the row level filter Hive policy applied for this user's group has been applied, restricting access to this information.\n\n![Count of actions](https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/chart.png)","user":"testuser1","dateUpdated":"2017-10-29T23:22:58+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509317811032_1279900739","id":"20171029-225651_5306647","dateCreated":"2017-10-29T22:56:51+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:25934","dateFinished":"2017-10-29T23:22:58+0000","dateStarted":"2017-10-29T23:22:58+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<ol>\n  <li>\n    <p>From Power BI Desktop, select dropdown under <strong>Get Data</strong>, then <strong>More&hellip;</strong>. In the Get Data window, select Azure, then Azure HDInsight Spark (Beta).</p>\n    <p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/get-data.png\" alt=\"Power BI Get Data\" /></p>\n  </li>\n  <li>\n  <p>Enter your Spark cluster&rsquo;s server name in the Server field. This will be [YOUR_CLUSTER_NAME].azurehdinsight.net.</p></li>\n  <li>Select DirectQuery as the data connectivity mode, then click OK.\n    <p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/get-data-directquery.png\" alt=\"Power BI DirectQuery\" /></p>\n  </li>\n  <li>\n  <p>Enter the domain credentials for <code>testuser1@contoso.com</code>.</p></li>\n  <li>After authenticating, continue to the next step and check the box next to the weblogs table, then click Load.\n    <p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/power-bi-get-data.png\" alt=\"Select the weblogs table\" /></p>\n  </li>\n</ol>\n<p>Now that the weblogs table is loaded and shown, along with its columns, on the right-hand side of the new report, follow these steps to create the chart:</p>\n<ol>\n  <li>Select the Clustered Column Chart visualization.</li>\n  <li>Drag the Action column within the weblogs table to the Axis field.</li>\n  <li>Drag the Action column to the Value field. This should display the Count of Action.\n    <p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/create-chart.png\" alt=\"Create the clustered column chart\" /></p>\n  </li>\n</ol>\n<p>You will see that the Add To Cart and Browsed actions are included, but not the Purchased action. This is because the row level filter Hive policy applied for this user&rsquo;s group has been applied, restricting access to this information.</p>\n<p><img src=\"https://raw.githubusercontent.com/ZoinerTejada/hdi-labs/master/Labs/Lab06/images/chart.png\" alt=\"Count of actions\" /></p>\n</div>"}]}},{"text":"%md\n## Conclusion\n\nIn the lab, you have learned how to configure security on a domain-joined cluster, view domain users and groups in Ambari, and see how those security policies are applied when executing queries in Zeppelin notebooks and Power BI.","user":"testuser1","dateUpdated":"2017-10-29T23:25:53+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":true,"language":"markdown"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509319273069_261921903","id":"20171029-232113_86437345","dateCreated":"2017-10-29T23:21:13+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:26048","dateFinished":"2017-10-29T23:25:53+0000","dateStarted":"2017-10-29T23:25:53+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>Conclusion</h2>\n<p>In the lab, you have learned how to configure security on a domain-joined cluster, view domain users and groups in Ambari, and see how those security policies are applied when executing queries in Zeppelin notebooks and Power BI.</p>\n</div>"}]}},{"text":"%md\n","user":"testuser1","dateUpdated":"2017-10-29T23:25:53+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":false,"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509319553083_1490808246","id":"20171029-232553_1041803181","dateCreated":"2017-10-29T23:25:53+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:26140"}],"name":"Lab06-complete","id":"2CXF8HTRA","angularObjects":{"2CHS8UYQQ:shared_process":[],"2CKX6DGQZ:shared_process":[],"2CK8A9MEG:shared_process":[],"2CKAY1A8Y:shared_process":[],"2CKX8WPU1:shared_process":[],"2CKEKWY8Z:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}